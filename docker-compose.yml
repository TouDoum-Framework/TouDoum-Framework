version: '3.3'

services:

  postgres:
    image: postgres
    restart: always
    environment:
      - POSTGRES_DB=TouDoum
      - POSTGRES_USER=please
      - POSTGRES_PASSWORD=change_me
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3-management
    hostname: rabbitmq
    restart: always
    environment:
      - DEFAULT_USER=white
      - DEFAULT_PASS=neo
    ports:
      - "5672:5672"
      - "15672:15672"

  redis:
    image: redis
    ports:
      - "6379:6379"

  master:
    image: msterhuj/toudoum
    build: .
    depends_on:
      - postgres
      - redis
    environment:
      - MODE=master
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=TouDoum
      - POSTGRES_USER=please
      - POSTGRES_PASSWORD=change_me
      - REDIS_URL="redis://127.0.0.1:6379/1"
      - SECRET_KEY=No_U
      - TOKEN="no.seriously.change.me"
      - ALLOWED_HOSTS=127.0.0.1,localhost
      - CELERY_EXTRA_ARGS="-l INFO -E"
    ports:
      - "8000:8000"

  worker:
    image: msterhuj/toudoum
    build: .
    depends_on:
      - master
    environment:
      - MODE=worker
      - API_URL="http://master:8000/api/v1"
      - TOKEN="no.seriously.change.me"